

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="securing-openstack-client-connections-part-2"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2012/12/21/securing-openstack-client-connections-part-2/" rel="bookmark" title="Permanent Link to Securing OpenStack Client Connections Part 2">Securing OpenStack Client Connections Part 2</a></h1>
      <p><small><span class="blog_post_date">December 21, 2012 at 12:12 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/x/blog/category/openstack/'>openstack</a>, <a href='/x/blog/category/devstack/'>devstack</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p>The OpenStack client repositories (or packages) include both the Python API bindings and the reference command line interface (CLI) implementation to communicate with the OpenStack APIs.   Client support for modern encrypted connections, i.e SSLv3 and/or TLSv1, has been spotty at best.</p>
<p>Most of the clients are capable of using SSL for encryption but often the certificate verification part of the protocol did not work properly for tier-2 or privately signed certificates, prompting the addition of the --insecure option to some of the clients.  In addition, most of the clients had no mechanism to specify an alternate CA bundle file to enable certificate verification.</p>
<p>Python has historically had incomplete X.509 certificate support in its standard library.  For example, ssl and httplib do not verify the hostname as part of certificate verification. Four of the clients (keystone, nova, cinder, quantum) use httplib2 which had no hostname verification before 0.7.0 and what it currently has is incomplete. The other two clients (glance and swift) use httplib directly and either have no hostname verification (swift) or implement it locally (glance).</p>
<div class="section" id="issue-summary">
<h1>Issue Summary</h1>
<ul class="simple">
<li>Python's ssl module does no certificate hostname verification in 2.7.x; it has been added in 3.2 but will not be backported.[1]</li>
<li>ssl is pinned to using protocol version SSLv23 and must be directly patched to override it.</li>
<li>httplib uses ssl and adds no hostname verification.  In addition it only uses the default SSLV23 protocol version set by ssl.  We don't want this as SSLv2 is deprecated and insecure.  Patching that value directly into the ssl module works but is suboptimal.</li>
<li>httplib2 implements a basic hostname verification but it has some problems such as only checking commonName if the certificate's subjectAltNames is not present and handling wildcards differently than specified in RFC-2818.</li>
<li>httplib2 uses an internal ca bundle (cacert.txt) if the ca_certs argument is not given to HTTPSConnectionWithTimeout.__init__().</li>
<li>In other news, httplib2 only supports 3xx redirects for GET method.</li>
</ul>
<div class="section" id="additional-notes">
<h2>Additional Notes</h2>
<p>glanceclient has patched the ssl module out of httplib in favor of pyOpenSSL.  Stuart McLaren added http.VerifiedHTTPSConnection.host_matches_cert() to validate commonName and subjectAltName for httplib connections but it doesn't handle wildcards.</p>
</div>
</div>
<div class="section" id="why-requests-2">
<h1>Why requests? [2]</h1>
<p>The requests module backported match_hostname() from Python 3.2.  Like all of the other modules here it does not handle the iPAddress attribute in subjectAltName. This is mostly relevant in development and testing use cases like with DevStack.  The 3.2 match_hostname() implementation however does allow IP addresses as a dNSName.</p>
<p>Requests also brings a number of other features to the table that may or may not have been implemented individually in the existing clients such as JSON encoding/decoding and 3xx redirection support for POST, PUT, PATCH DELETE, and HEAD.  Plus it is stable (notwithstanding the recent 1.0 release) and the developer is known in the OS community.</p>
</div>
<div class="section" id="the-cli-solution">
<h1>The CLI Solution</h1>
<p>The current round of patches to the CLIs is to get them all up to the same level of support for TLSv1 for authentication, at a minimum.  Glance and Swift continue to use httplib directly for their data transfer connections (really, all connections to their respective services) and these already support SSL.v?.</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="16%" />
<col width="44%" />
<col width="16%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Client</th>
<th class="head">HTTP Module</th>
<th class="head">Client object</th>
<th class="head">CLI Arg</th>
<th class="head">Env Var</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>keystone</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>--os-cacert</td>
<td>OS_CACERT</td>
</tr>
<tr><td>nova</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr><td>cinder</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr><td>glance</td>
<td>httplib</td>
<td>class.HTTPClient(object)</td>
<td>--ca-file</td>
<td>n/a</td>
</tr>
<tr><td>swift</td>
<td>httplib</td>
<td>class Connection(object)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr><td>quantum</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
</tbody>
</table>
<p>The approach taken for the httplib2 subclasses is to change the parent class to object and reqork the request() method to call requests.request().  Some of the differences for requests leaked out of that method but have been mostly containd within the HTTPClient class.  All four of the clients (formetly) using httplib2 have implemented one or more features that can easily be handled by requests (redirection) or should also be propogated to the other clients.  This is ripe for a refactor of HTTPClient to a common module but that effort is not in scope here.</p>
<p>keystoneclient (complete) <a class="reference external" href="https://review.openstack.org/#/c/17624/">https://review.openstack.org/#/c/17624/</a></p>
<ul class="simple">
<li>replace httplib2 with requests</li>
</ul>
<p>novaclient (complete) <a class="reference external" href="https://review.openstack.org/#/c/18257/">https://review.openstack.org/#/c/18257/</a></p>
<ul class="simple">
<li>replace httplib2 with requests</li>
<li>add --os-cacert and OS_CACERT support</li>
<li>provide ca_cert to keystone clinet for authentication</li>
</ul>
<p>cinderclient (complete) <a class="reference external" href="https://review.openstack.org/#/c/18278/">https://review.openstack.org/#/c/18278/</a></p>
<ul class="simple">
<li>replace httplib2 with requests</li>
<li>add --os-cacert and OS_CACERT support</li>
<li>provide ca_cert to keystone clinet for authentication</li>
</ul>
<p>glanceclient (complete) <a class="reference external" href="https://review.openstack.org/#/c/17698/">https://review.openstack.org/#/c/17698/</a></p>
<ul class="simple">
<li>rename --ca-cert to --os-cacert and add OS_CACERT</li>
<li>provide ca_cert to keystone client for authentication</li>
</ul>
<p>swiftclient (complete) <a class="reference external" href="https://review.openstack.org/#/c/18393/">https://review.openstack.org/#/c/18393/</a></p>
<ul class="simple">
<li>add --os-cacert and OS_CACERT support</li>
<li>provide ca_cert to keystone client for authentication</li>
</ul>
<p>quantumclient (not started)</p>
<ul class="simple">
<li>replace httplib2 with requests</li>
<li>add --os-cacert and OS_CACERT support</li>
<li>provide ca_cert to keystone clinet for authentication</li>
</ul>
<div class="section" id="testing">
<h2>Testing</h2>
<p>Aside from the usual unit tests, support for a TLS proxy is being added to DevStack to demonstrate and test a TLS-enabled OpenStack configuration.  It uses stud as the TLS endpoint that proxies to the usual service endpoints.  The most interesting challenge here is doing it all on a single host and making the service catalog work.  Yay!</p>
<p>The TLS-in-DevStack also builds a two-tiered CA (root and intermediate) for testing proper certificate chain validation.</p>
</div>
</div>
<div class="section" id="links">
<h1>Links</h1>
<ul class="simple">
<li>glanceclient host_matches_cert(): <a class="reference external" href="https://review.openstack.org/#/c/16305/4/glanceclient/common/http.py">https://review.openstack.org/#/c/16305/4/glanceclient/common/http.py</a></li>
<li>request's urllib3.ssl_match_hostname.match_hostname(): <a class="reference external" href="https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/connectionpool.py#L72">https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/connectionpool.py#L72</a> <a class="reference external" href="https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/packages/ssl_match_hostname/__init__.py#L23">https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/packages/ssl_match_hostname/__init__.py#L23</a></li>
</ul>
<p>[1]: <a class="reference external" href="http://bugs.python.org/issue1589">http://bugs.python.org/issue1589</a>, the comments about 2.x begin at <a class="reference external" href="http://bugs.python.org/issue1589#msg120946">http://bugs.python.org/issue1589#msg120946</a></p>
<p>[2]: The patches for the OpenStack CLIs were engineered and implemented before the release of requests 1.0 which is a significantly different implementation and is untested in our application.</p>
</div>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2012/12/21/securing-openstack-client-connections-part-2/">Securing OpenStack Client Connections Part 2</a></li>
      <li><a href="/x/blog/2012/12/18/securing-client-connections/">Securing Client Connections</a></li>
      <li><a href="/x/blog/2012/10/20/devstack-at-one/">Devstack At One</a></li>
      <li><a href="/x/blog/2011/05/11/syntax-highlight-test/">Syntax highlight test</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2013
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






