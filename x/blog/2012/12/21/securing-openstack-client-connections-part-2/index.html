

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="securing-openstack-client-connections-part-2"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2012/12/21/securing-openstack-client-connections-part-2/" rel="bookmark" title="Permanent Link to Securing OpenStack Client Connections Part 2">Securing OpenStack Client Connections Part 2</a></h1>
      <p><small><span class="blog_post_date">December 21, 2012 at 12:12 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/x/blog/category/openstack/'>openstack</a>, <a href='/x/blog/category/devstack/'>devstack</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p>In the first part of this series we covered creating a pair of certificate authorities and a signed certificate with the same attributes commonly found in commercial certificates.  This part covers the OpenStack Python clients and proper certificate verification.</p>
<p>The OpenStack client repositories (or packages) include both the Python API bindings and the reference command line interface (CLI) implementation to communicate with the OpenStack APIs.   Client support for modern encrypted connections, i.e SSLv3 and/or TLSv1, has been spotty at best.</p>
<p>Most of the clients are capable of using SSL for encryption but often the certificate verification part of the protocol did not work properly for tier-2 or privately signed certificates, prompting the addition of the <tt class="docutils literal"><span class="pre">--insecure</span></tt> option to some of the clients to sidestep the problem altogether.  In addition, most of the clients had no mechanism to specify an alternate CA bundle file to enable certificate verification for certificates not signed by the commercial CAs.</p>
<p>Python has historically had incomplete X.509 certificate support in its standard library.  For example, <tt class="docutils literal">ssl</tt> and <tt class="docutils literal">httplib</tt> do not verify the hostname as part of certificate verification. Four of the clients (keystone, nova, cinder, quantum) use <tt class="docutils literal">httplib2</tt> which had no hostname verification before version 0.7.0 and what it currently has is also incomplete. The other two clients (glance and swift) use <tt class="docutils literal">httplib</tt> directly and either have no hostname verification (swift) or implement it locally (glance).</p>
<div class="section" id="issue-summary">
<h1>Issue Summary</h1>
<ul class="simple">
<li>Python's <tt class="docutils literal">ssl</tt> module does no certificate hostname verification in 2.7.x; it has been added in 3.2 but will not be backported. <a class="footnote-reference" href="#id3" id="id1">[1]</a></li>
<li><tt class="docutils literal">ssl</tt> is pinned to using protocol version <tt class="docutils literal">SSLv23</tt> and must be directly patched to override it.</li>
<li><tt class="docutils literal">httplib</tt> uses <tt class="docutils literal">ssl</tt> and adds no hostname verification.  In addition it only uses the default <tt class="docutils literal">SSLV23</tt> protocol version set by <tt class="docutils literal">ssl</tt>.  We don't want this as SSLv2 is deprecated and insecure.  Patching that value directly into the <tt class="docutils literal">ssl</tt> module works but is suboptimal.</li>
<li><tt class="docutils literal">httplib2</tt> implements a basic hostname verification but it has some problems such as only checking <tt class="docutils literal">commonName</tt> if the certificate's <tt class="docutils literal">subjectAltNames</tt> is not present and handling wildcards differently than specified in RFC-2818.</li>
<li><tt class="docutils literal">httplib2</tt> uses an internal ca bundle (<tt class="docutils literal">cacert.txt</tt>) if the <tt class="docutils literal">ca_certs</tt> argument is not given to <tt class="docutils literal">HTTPSConnectionWithTimeout.__init__()</tt>.</li>
<li>In other news, <tt class="docutils literal">httplib2</tt> only supports 3xx redirects for GET method.</li>
</ul>
<div class="section" id="additional-notes">
<h2>Additional Notes</h2>
<p>glanceclient has patched the <tt class="docutils literal">ssl</tt> module out of <tt class="docutils literal">httplib</tt> in favor of <tt class="docutils literal">pyOpenSSL</tt>.  Stuart McLaren added <tt class="docutils literal">http.VerifiedHTTPSConnection.host_matches_cert()</tt> to validate <tt class="docutils literal">commonName</tt> and <tt class="docutils literal">subjectAltName</tt> for <tt class="docutils literal">httplib</tt> connections but it doesn't handle wildcards.</p>
</div>
</div>
<div class="section" id="why-requests-2">
<h1>Why requests? <a class="footnote-reference" href="#id4" id="id2">[2]</a></h1>
<p>The <tt class="docutils literal">requests</tt> module backported <tt class="docutils literal">match_hostname()</tt> from Python 3.2.  Like the rest of the modules here it does not handle the <tt class="docutils literal">iPAddress</tt> attribute in <tt class="docutils literal">subjectAltName</tt>. This is mostly relevant in development and testing use cases like with DevStack.  The 3.2 <tt class="docutils literal">match_hostname()</tt> implementation however does allow IP addresses as a <tt class="docutils literal">dNSName</tt>.</p>
<p><tt class="docutils literal">requests</tt> also brings a number of other features to the table that may or may not have been implemented individually in the existing clients such as JSON encoding/decoding and 3xx redirection support for POST, PUT, PATCH DELETE, and HEAD.  Plus it is stable (notwithstanding the recent 1.0 release) and the developer is known in the OS community.</p>
</div>
<div class="section" id="the-cli-solution">
<h1>The CLI Solution</h1>
<p>There has recently been a round of patches to the CLIs to get them all up to the same level of support for TLSv1 to be used for authentication at a minimum.  Glance and Swift continue to use <tt class="docutils literal">httplib</tt> directly for their data transfer connections (really, all connections to their respective services) and these already support SSLv3.</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="16%" />
<col width="44%" />
<col width="16%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Client</th>
<th class="head">HTTP Module</th>
<th class="head">Client object</th>
<th class="head">CLI Arg</th>
<th class="head">Env Var</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>keystone</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>--os-cacert</td>
<td>OS_CACERT</td>
</tr>
<tr><td>nova</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr><td>cinder</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr><td>glance</td>
<td>httplib</td>
<td>class.HTTPClient(object)</td>
<td>--ca-file</td>
<td>n/a</td>
</tr>
<tr><td>swift</td>
<td>httplib</td>
<td>class Connection(object)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr><td>quantum</td>
<td>httplib2</td>
<td>class.HTTPClient(httplib2.Http)</td>
<td>n/a</td>
<td>n/a</td>
</tr>
</tbody>
</table>
<p>The approach taken for the <tt class="docutils literal">httplib2</tt> subclasses is to change the parent class to <tt class="docutils literal">object</tt> and rework the <tt class="docutils literal">request()</tt> method to call <tt class="docutils literal">requests.request()</tt>.  Some of the differences for <tt class="docutils literal">requests</tt> leaked out of that method but have been mostly containd within the <tt class="docutils literal">HTTPClient</tt> class.  All four of the clients (formerly) using <tt class="docutils literal">httplib2</tt> have implemented one or more features that can easily be handled by <tt class="docutils literal">requests</tt> (redirection) or should also be propogated to the other clients.  This is ripe for a refactor of <tt class="docutils literal">HTTPClient</tt> to a common module but that effort is not in scope here.</p>
<div class="section" id="keystoneclient">
<h2>keystoneclient</h2>
<p>Implemented in <a class="reference external" href="https://review.openstack.org/#/c/17624/">https://review.openstack.org/#/c/17624/</a> <em>(complete)</em></p>
<ul class="simple">
<li>replace <tt class="docutils literal">httplib2</tt> with <tt class="docutils literal">requests</tt></li>
</ul>
</div>
<div class="section" id="novaclient">
<h2>novaclient</h2>
<p>Implemented in <a class="reference external" href="https://review.openstack.org/#/c/18257/">https://review.openstack.org/#/c/18257/</a> <em>(complete)</em></p>
<ul class="simple">
<li>replace <tt class="docutils literal">httplib2</tt> with <tt class="docutils literal">requests</tt></li>
<li>add <tt class="docutils literal"><span class="pre">--os-cacert</span></tt> and <tt class="docutils literal">OS_CACERT</tt> support</li>
<li>provide <tt class="docutils literal">ca_cert</tt> to keystone client for authentication</li>
</ul>
</div>
<div class="section" id="cinderclient">
<h2>cinderclient</h2>
<p>Implemented in <a class="reference external" href="https://review.openstack.org/#/c/18278/">https://review.openstack.org/#/c/18278/</a> <em>(complete)</em></p>
<ul class="simple">
<li>replace <tt class="docutils literal">httplib2</tt> with <tt class="docutils literal">requests</tt></li>
<li>add <tt class="docutils literal"><span class="pre">--os-cacert</span></tt> and <tt class="docutils literal">OS_CACERT</tt> support</li>
<li>provide <tt class="docutils literal">ca_cert</tt> to keystone client for authentication</li>
</ul>
</div>
<div class="section" id="glanceclient">
<h2>glanceclient</h2>
<p>Implemented in <a class="reference external" href="https://review.openstack.org/#/c/17698/">https://review.openstack.org/#/c/17698/</a> <em>(complete)</em></p>
<ul class="simple">
<li>rename <tt class="docutils literal"><span class="pre">--ca-cert</span></tt> to <tt class="docutils literal"><span class="pre">--os-cacert</span></tt> and add <tt class="docutils literal">OS_CACERT</tt></li>
<li>provide <tt class="docutils literal">ca_cert</tt> to keystone client for authentication</li>
</ul>
</div>
<div class="section" id="swiftclient">
<h2>swiftclient</h2>
<p>Implemented in <a class="reference external" href="https://review.openstack.org/#/c/18393/">https://review.openstack.org/#/c/18393/</a> <em>(complete)</em></p>
<ul class="simple">
<li>add <tt class="docutils literal"><span class="pre">--os-cacert</span></tt> and <tt class="docutils literal">OS_CACERT</tt> support</li>
<li>provide <tt class="docutils literal">ca_cert</tt> to keystone client for authentication</li>
</ul>
</div>
<div class="section" id="quantumclient">
<h2>quantumclient</h2>
<p><em>(not started)</em></p>
<ul class="simple">
<li>replace <tt class="docutils literal">httplib2</tt> with <tt class="docutils literal">requests</tt></li>
<li>add <tt class="docutils literal"><span class="pre">--os-cacert</span></tt> and <tt class="docutils literal">OS_CACERT</tt> support</li>
<li>provide <tt class="docutils literal">ca_cert</tt> to keystone client for authentication</li>
</ul>
</div>
<div class="section" id="testing">
<h2>Testing</h2>
<p>Aside from the usual unit tests, support for a TLS proxy is being added to DevStack to demonstrate and test a TLS-enabled OpenStack configuration.  It uses <tt class="docutils literal">stud</tt> as the TLS endpoint that proxies to the usual service endpoints.  The most interesting challenge here is doing it all on a single host and making the service catalog work.  Yay!  This will be described in (hopefully) the next post in this series.</p>
<p>The TLS-in-DevStack also builds a two-tiered CA (root and intermediate) for testing proper certificate chain validation as described in <a class="reference external" href="/x/blog/2012/12/18/securing-openstack-client-connections-part-1/">the first installment</a>.</p>
</div>
</div>
<div class="section" id="links">
<h1>Links</h1>
<ul class="simple">
<li>glanceclient <tt class="docutils literal">host_matches_cert()</tt>: <a class="reference external" href="https://review.openstack.org/#/c/16305/4/glanceclient/common/http.py">https://review.openstack.org/#/c/16305/4/glanceclient/common/http.py</a></li>
<li><tt class="docutils literal">request</tt>'s <tt class="docutils literal">urllib3.ssl_match_hostname.match_hostname()</tt>: <a class="reference external" href="https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/connectionpool.py#L72">https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/connectionpool.py#L72</a> <a class="reference external" href="https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/packages/ssl_match_hostname/__init__.py#L23">https://github.com/kennethreitz/requests/blob/master/requests/packages/urllib3/packages/ssl_match_hostname/__init__.py#L23</a></li>
</ul>
<hr class="docutils" />
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://bugs.python.org/issue1589">Python issue 1589</a>, the comments about 2.x <a class="reference external" href="http://bugs.python.org/issue1589#msg120946">begin here</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>The patches for the OpenStack CLIs were engineered and implemented before the release of <tt class="docutils literal">requests</tt> 1.0 which is a significantly different implementation and is untested in our application.</td></tr>
</tbody>
</table>
</div>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2014/10/03/a-funny-thing-happened-on-the-way-to-the-summit/">A Funny Thing Happened On The Way To The Summit</a></li>
      <li><a href="/x/blog/2014/09/15/openstack-low-level-api/">OpenStack Low Level API</a></li>
      <li><a href="/x/blog/2014/08/17/openwrt-images-for-openstack/">OpenWRT Images for OpenStack</a></li>
      <li><a href="/x/blog/2014/07/13/more-notes-on-windows-images/">More Notes on Windows Images</a></li>
      <li><a href="/x/blog/2014/07/07/windows-images-for-openstack/">Windows Images for OpenStack</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2014
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






