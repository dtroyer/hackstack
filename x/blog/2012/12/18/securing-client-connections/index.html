

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="securing-client-connections"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2012/12/18/securing-client-connections/" rel="bookmark" title="Permanent Link to Securing Client Connections">Securing Client Connections</a></h1>
      <p><small><span class="blog_post_date">December 18, 2012 at 12:12 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/x/blog/category/openstack/'>openstack</a>, <a href='/x/blog/category/devstack/'>devstack</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p>The difference of <tt class="docutils literal">https</tt> over <tt class="docutils literal">http</tt> is the addition of encryption, right?  Yes, but it is also meant to include the addition of verification/validation of one or both of the paries involved in the connection.  In the common case of a user directing a web browser to a 'secure' site, only one side is potentially validated, that being the server.  Maybe.</p>
<p>Browsers generally go a good job of performing server certificate validation but other https clients may not do so well.  Sometimes the web browser will pop up a box saying that the server is untrusted for one reason or another.  This is the result of a failure to validate the server certificate.  It will usually contain the reason for the failure but generally it also contains a button to click on that allows the connection to proceed.  This effectively neuters the validation process and opens the door for server spoofing and man-in-the-middle attacks.</p>
<p>The point here is not to rehash the merits of that behaviour but to demonstrate the parallel with other users of <tt class="docutils literal">https</tt> and uncovering the characteristics in how they handle encryption and validation of server certificates.  Specifically this is a look into how the OpenStack Python REST clients behave and how to validate the certificate validation.  Mmmmmm...recursion...</p>
<div class="section" id="but-first">
<h1>But First</h1>
<p>Before we can delve into the world of Python modules and SSL wrappers we must first have a way to test against some known secure servers.  This means uncorking some OpenSSL-foo and entering the dark world of certificate authorities (CA).  &quot;But that's been covered to death!&quot; you may say.  Yes it has, but generally only to the level of self-sigining a cert for use in private servers.  I believe the common name for these certs is 'snakeoil'.  Occasionally you will find a walkthrough that introduces an intermediate certificate authority to better emulate the real-world certificates obtained from the commercial vendors that have their root CA certificates included in the lists shipped with most operating systems, browsers and even some programming libraries.</p>
<p>Our goal then is to build a server certificate that is a) signed by an intermediate CA and b) has the basic attributes and extensions common in real-world certificates.  To get that we need a root CA and to get that we need some code.  The approach taken here is to create OpenSSL configuration files that illustrate the configuration file sections that are used for each operation.</p>
</div>
<div class="section" id="root-ca">
<h1>Root CA</h1>
<p>Creating a self-signed root CA is a common operation and has been covered many times elsewhere.  So here are the basics:</p>
<ul>
<li><p class="first">create root CA dir structure:</p>
<pre class="literal-block">
for i in certs crl newcerts private; do
    mkdir -p CA/root-ca/$i
done
chmod 710 CA/root-ca/private
echo &quot;01&quot; &gt;CA/root-ca/serial
cp /dev/null CA/root-ca/index.txt
</pre>
</li>
<li><p class="first">generate CA/root-ca/ca.conf:</p>
<pre class="literal-block">
echo '
[ ca ]
default_ca = CA_default

[ CA_default ]
dir                     = ./CA/root-ca
policy                  = policy_match
database                = $dir/index.txt
serial                  = $dir/serial
certs                   = $dir/certs
crl_dir                 = $dir/crl
new_certs_dir           = $dir/newcerts
certificate             = $dir/cacert.pem
private_key             = $dir/private/cacert.key
RANDFILE                = $dir/private/.rand
default_md              = default

[ req ]
default_bits            = 1024
default_md              = sha1

prompt                  = no
distinguished_name      = ca_distinguished_name

x509_extensions         = ca_extensions

[ ca_distinguished_name ]
organizationName        = Example Inc.
organizationalUnitName  = Certificate Authority
emailAddress            = ca&#64;example.com
commonName              = Example Inc Root CA

[ policy_match ]
countryName             = optional
stateOrProvinceName     = optional
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

[ ca_extensions ]
basicConstraints        = critical,CA:true
subjectKeyIdentifier    = hash
authorityKeyIdentifier  = keyid:always, issuer
keyUsage                = cRLSign, keyCertSign

' &gt;CA/root-ca/ca.conf
</pre>
</li>
<li><p class="first">generate a private key and self-signed certificate:</p>
<pre class="literal-block">
openssl req -config CA/root-ca/ca.conf -x509 -nodes -newkey rsa -days 21360 \
    -out CA/root-ca/cacert.pem \
    -keyout CA/root-ca/private/cacert.key \
    -outform PEM
</pre>
</li>
<li><p class="first">take a peek at the root certificate:</p>
<pre class="literal-block">
openssl x509 -noout -text -in CA/root-ca/cacert.pem
</pre>
</li>
</ul>
</div>
<div class="section" id="intermediate-ca">
<h1>Intermediate CA</h1>
<p>Creating an Intermediate CA is very similar except the root CA must do the signing so the process takes a couple of additional steps:</p>
<ul>
<li><p class="first">create intermediate CA dir structure:</p>
<pre class="literal-block">
for i in certs crl newcerts private; do
    mkdir -p CA/int-ca/$i
done
chmod 710 CA/int-ca/private
echo &quot;01&quot; &gt;CA/int-ca/serial
cp /dev/null CA/int-ca/index.txt
</pre>
</li>
<li><p class="first">generate CA/int-ca/ca.conf:</p>
<pre class="literal-block">
echo '
[ ca ]
default_ca = CA_default

[ CA_default ]
dir                     = ./CA/int-ca
policy                  = policy_match
database                = $dir/index.txt
serial                  = $dir/serial
certs                   = $dir/certs
crl_dir                 = $dir/crl
new_certs_dir           = $dir/newcerts
certificate             = $dir/cacert.pem
private_key             = $dir/private/cacert.key
RANDFILE                = $dir/private/.rand
default_md              = default

[ req ]
default_bits            = 1024
default_md              = sha1

prompt                  = no
distinguished_name      = ca_distinguished_name

x509_extensions         = ca_extensions

[ ca_distinguished_name ]
organizationName        = Example Inc.
organizationalUnitName  = Certificate Authority
emailAddress            = ca&#64;example.com
commonName              = Example Inc Intermediate CA

[ policy_match ]
countryName             = optional
stateOrProvinceName     = optional
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

[ ca_extensions ]
basicConstraints        = critical,CA:true
subjectKeyIdentifier    = hash
authorityKeyIdentifier  = keyid:always, issuer
keyUsage                = cRLSign, keyCertSign

' &gt;CA/int-ca/ca.conf
</pre>
</li>
<li><dl class="first docutils">
<dt>generate a private key and self-signed certificate::</dt>
<dd><dl class="first last docutils">
<dt>openssl req -config CA/int-ca/ca.conf -sha1 -newkey rsa -nodes </dt>
<dd><p class="first last">-out CA/int-ca/int-ca.csr -keyout CA/int-ca/private/cacert.key -outform PEM</p>
</dd>
<dt>openssl ca -config CA/root-ca/ca.conf -extensions ca_extensions -days 365 -notext </dt>
<dd><p class="first last">-out CA/int-ca/cacert.pem -in CA/int-ca/int-ca.csr -batch</p>
</dd>
</dl>
</dd>
</dl>
</li>
<li><p class="first">make a trust chain:</p>
<pre class="literal-block">
cat CA/root-ca/cacert.pem CA/int-ca/cacert.pem &gt;&gt;CA/int-ca/ca-chain.pem
</pre>
</li>
<li><p class="first">take a peek at the intermediate certificate:</p>
<pre class="literal-block">
openssl x509 -noout -text -in CA/int-ca/cacert.pem
</pre>
</li>
</ul>
</div>
<div class="section" id="server-certificate">
<h1>Server Certificate</h1>
<ul>
<li><p class="first">generate CA/int-ca/sign.conf:</p>
<pre class="literal-block">
echo '
[ ca ]
default_ca = CA_default

[ CA_default ]
dir                     = ./CA/int-ca
policy                  = policy_match
database                = $dir/index.txt
serial                  = $dir/serial
certs                   = $dir/certs
crl_dir                 = $dir/crl
new_certs_dir           = $dir/newcerts
certificate             = $dir/cacert.pem
private_key             = $dir/private/cacert.key
RANDFILE                = $dir/private/.rand
default_md              = default

[ req ]
default_bits            = 1024
default_md              = sha1

prompt                  = no
distinguished_name      = req_distinguished_name

x509_extensions         = req_extensions

[ req_distinguished_name ]
organizationName        = Example Inc.

[ policy_match ]
countryName             = optional
stateOrProvinceName     = optional
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied

[ req_extensions ]
basicConstraints        = CA:false
subjectKeyIdentifier    = hash
authorityKeyIdentifier  = keyid:always, issuer
keyUsage                = digitalSignature, keyEncipherment, keyAgreement
extendedKeyUsage        = serverAuth, clientAuth
subjectAltName          = $ENV::SUBJECT_ALT_NAME

' &gt;CA/int-ca/sign.conf
</pre>
</li>
<li><p class="first">generate a signing request:</p>
<pre class="literal-block">
openssl req -sha1 -newkey rsa -nodes \
    -keyout CA/int-ca/private/cert.example.com.key \
    -out CA/int-ca/cert.example.com.csr \
    -subj '/O=Example Inc./OU=Servers/CN=cert.example.com'

SUBJECT_ALT_NAME=&quot;IP: 1.2.3.4&quot; \
openssl ca -config CA/int-ca/sign.conf -extensions req_extensions -days 365 -notext \
    -out CA/int-ca/cert.example.com.crt \
    -in CA/int-ca/cert.example.com.csr \
    -batch
</pre>
</li>
<li><p class="first">take a peek at the server certificate:</p>
<pre class="literal-block">
openssl x509 -noout -text -in CA/int-ca/cert.example.com.pem
</pre>
</li>
</ul>
</div>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2012/12/21/securing-openstack-client-connections-part-2/">Securing OpenStack Client Connections Part 2</a></li>
      <li><a href="/x/blog/2012/12/18/securing-client-connections/">Securing Client Connections</a></li>
      <li><a href="/x/blog/2012/10/20/devstack-at-one/">Devstack At One</a></li>
      <li><a href="/x/blog/2011/05/11/syntax-highlight-test/">Syntax highlight test</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2013
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






