

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="devstack-local-config"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2013/09/07/devstack-local-config/" rel="bookmark" title="Permanent Link to DevStack Local Config">DevStack Local Config</a></h1>
      <p><small><span class="blog_post_date">September 07, 2013 at 09:17 AM</span> | categories: 
        <span class="blog_post_categories"><a href='/x/blog/category/openstack/'>openstack</a>, <a href='/x/blog/category/devstack/'>devstack</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p>DevStack has long had an extremely simple mechanism to add arbitrary configuration entries to nova.con, <tt class="docutils literal">EXTRA_OPTS</tt>.  It was handy and even emulated in the Neutron configuration in a number of places.  However, it did not scale well: a new variable and expansion loop is required for each file/section combination.  And now the time has come for a replacement...</p>
<div class="section" id="requirements">
<h1>Requirements</h1>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">localrc</tt> has served well in its capacity of the sole container of local configuration.  Being a single file makes it easy to track and share known working DevStack configurations.  Any new configuration scheme must at least attempt to preserve this property.</li>
<li>In order to be able to set configuration attributes in arbitrary files and sections, those bits of information must be encoded in the new format.</li>
<li>There must be a mechanism to selectively merge the configuration values into their destination files rather than do them all at once.</li>
<li>Reduce the number of configuration variables in general that are simply passed-through to project config files.  They are being set in localrc anyway, moving that to another section of local.conf is not a difficult transition.</li>
</ul>
</blockquote>
</div>
<div class="section" id="solution">
<h1>Solution</h1>
<p>A new master local configuration file is supported (but like <tt class="docutils literal">localrc</tt> is not included in the DevStack repo) that all local configuration for DevStack, including the master copy of <tt class="docutils literal">localrc</tt>.  <tt class="docutils literal">local.conf</tt> is an extended-INI format that introduces a new meta-section header that contains the additional required information: a group name and destination configuration filename.  It has the form:</p>
<pre class="literal-block">
[[ &lt;group&gt; | &lt;filename&gt; ]]
</pre>
<p>where &lt;group&gt; is the usual DevStack project name (<tt class="docutils literal">nova</tt>, <tt class="docutils literal">cinder</tt>, etc) and &lt;filename&gt; is the config filename.  The filename is eval'ed in the <tt class="docutils literal">stack.sh</tt> context so all environment variables are available and may be used (see example below).</p>
<p>The file is processed strictly in sequence.  Meta-sections may be specified more than once, if any settings are duplicated the last to appear in the file will be used:</p>
<pre class="literal-block">
[[nova|$NOVA_CONF]]
[DEFAULT]
use_syslog = True

[osapi_v3]
enabled = False
</pre>
<p>A special meta-section <tt class="docutils literal">[[local:localrc]]</tt> is used to provide a default localrc file.  This allows all custom settings for DevStack to be contained in a single file:</p>
<pre class="literal-block">
[[local|localrc]]
FIXED_RANGE=10.254.1.0/24
ADMIN_PASSWORD=speciale
LOGFILE=$DEST/logs/stack.sh.log
</pre>
</div>
<div class="section" id="implementation">
<h1>Implementation</h1>
<p>Four new functions were added to parse and merge <tt class="docutils literal">local.conf</tt> into the existing INI-style config files.  The base <tt class="docutils literal">functions</tt> file is getting way too large so these functions are in <tt class="docutils literal">lib/config</tt> which will only contain functions related to config file manipulation.  There shall also be no side-effects from any of these functions.  The existing <tt class="docutils literal">iniXXX()</tt> functions may also eventually move here.</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">get_meta_section()</tt> - Returns an INI fragment for a specific group/filename combination</li>
<li><tt class="docutils literal">get_meta_section_files()</tt> - Returns a list of the config filenames present in <tt class="docutils literal">local.conf</tt> for a specific group</li>
<li><tt class="docutils literal">merge_config_file()</tt> - Performs the actual merge of the INI fragment from <tt class="docutils literal">local.conf</tt></li>
<li><tt class="docutils literal">merge_config_group()</tt> - Loops over the INI fragments present for the specified group and merges them</li>
</ul>
</blockquote>
<p>The merge is performed after the <tt class="docutils literal">install_XXX()</tt> and <tt class="docutils literal">configure_XXX()</tt> functions for all layer 1 and 2 projects are complete and before any services are started.</p>
</div>
<div class="section" id="use-it-or-lose-it">
<h1>Use It Or Lose It</h1>
<p>The list of existing variables that will be deprecated in favor of using <tt class="docutils literal">local.conf</tt> has not been completed yet but includes <tt class="docutils literal">EXTRA_OPTS</tt> and a handful of <tt class="docutils literal">Q_XXX_XXX_OPTS</tt> variables in Neutron.  These are listed at the end of <tt class="docutils literal">stack.sh</tt> runs as deprecated and will be removed sometime in the Icehouse development cycle after DevStack's stable/havana branch is in place and Grenade's Grizzly-&gt;Havana upgrade is operational.</p>
<div class="section" id="examples">
<h2>Examples</h2>
<ul>
<li><p class="first">Convert EXTRA_OPTS from:</p>
<pre class="literal-block">
EXTRA_OPTS=api_rate_limit=False

to

[[nova|$NOVA_CONF]]
[DEFAULT]
api_rate_limit = False
</pre>
</li>
<li><p class="first">Eliminate a Cinder pass-through (<tt class="docutils literal">CINDER_PERIODIC_INTERVAL</tt>):</p>
<pre class="literal-block">
[[cinder|$CINDER_CONF]]
[DEFAULT]
periodic_interval = 60
</pre>
</li>
<li><p class="first">Change a setting that has no variable:</p>
<pre class="literal-block">
[[cinder|$CINDER_CONF]]
[DEFAULT]
iscsi_helper = new-tgtadm
</pre>
</li>
<li><p class="first">Basic complete config:</p>
<pre class="literal-block">
[[nova|$NOVA_CONF]]
[DEFAULT]
api_rate_limit = False

[vmware]
host_ip = $HOST_IP
host_username = root
host_password = deepdarkunknownsecret


[[cinder|$CINDER_CONF]]
[DEFAULT]
periodic_interval = 60

vmware_host_ip = $HOST_IP
vmware_host_username = root
vmware_host_password = deepdarkunknownsecret


[[local|localrc]]
FIXED_RANGE=10.254.1.0/24
NETWORK_GATEWAY=10.254.1.1
LOGDAYS=1
LOGFILE=$DEST/logs/stack.sh.log
SCREEN_LOGDIR=$DEST/logs/screen
ADMIN_PASSWORD=quiet
DATABASE_PASSWORD=$ADMIN_PASSWORD
RABBIT_PASSWORD=$ADMIN_PASSWORD
</pre>
</li>
</ul>
</div>
</div>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2013/09/07/devstack-local-config/">DevStack Local Config</a></li>
      <li><a href="/x/blog/2013/09/05/openstack-seven-layer-dip-as-a-service/">OpenStack - Seven Layer Dip as a Service</a></li>
      <li><a href="/x/blog/2013/06/20/openstack-clients-on-windows/">OpenStack Clients on Windows</a></li>
      <li><a href="/x/blog/2013/06/20/openstack-clients/">OpenStack Clients</a></li>
      <li><a href="/x/blog/2013/04/25/a-centos-6-image-for-openstack/">A CentOS 6 Image for OpenStack</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2013
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






