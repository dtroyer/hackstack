

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="a-centos-6-image-for-openstack"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2013/04/25/a-centos-6-image-for-openstack/" rel="bookmark" title="Permanent Link to A CentOS 6 Image for OpenStack">A CentOS 6 Image for OpenStack</a></h1>
      <p><small><span class="blog_post_date">April 25, 2013 at 04:25 AM</span> | categories: 
        <span class="blog_post_categories"><a href='/x/blog/category/openstack/'>openstack</a>, <a href='/x/blog/category/rhel/'>rhel</a>, <a href='/x/blog/category/centos/'>centos</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p><em>[Updated 01Oct2013 to correct spelling and command formatting]</em></p>
<p>This is the next installment in the never-ending series of OpenStack image builds.  Today's
target: CentOS</p>
<div class="section" id="image-characteristics">
<h1>Image Characteristics</h1>
<p>The usual suspects are present:</p>
<ul class="simple">
<li>minimal package install</li>
<li>serial console support</li>
<li>timezone is <tt class="docutils literal">Etc/UTC</tt></li>
<li>hostname set to instance name</li>
<li>a single partition with root filesystem, no swap</li>
<li>grow root filesystem to device size</li>
<li>enable EPEL (install epel-release)</li>
<li>enable could-init repo to get 0.7.1</li>
</ul>
<p>A few things are still lacking:</p>
<ul class="simple">
<li>selinux is in permissive mode, make enforcing</li>
<li>strengthen default firewall</li>
</ul>
</div>
<div class="section" id="build">
<h1>Build</h1>
<p>Tools like <tt class="docutils literal">Oz</tt> are a good idea in theory but in practice seem to be quite picky about the environment
they will correctly run on.  I'm looking at you <tt class="docutils literal">libguestfs</tt>.  Other tools like the venerable <tt class="docutils literal"><span class="pre">appliance-creator</span></tt> get hung up
on needing the same version of things in the host as in the chroot.</p>
<p>Good ole <tt class="docutils literal"><span class="pre">virt-install</span></tt> happily runs on damn near everything.  This build has been tested
on CentOS 6.4 and Ubuntu 12.10.  <cite>TODO(dtroyer): don't run this all as root</cite></p>
<p>Let's get started.</p>
<ul>
<li><p class="first">Install <cite>virt-install</cite> and all its prerequisites</p>
<ul>
<li><p class="first">on Ubuntu:</p>
<pre class="literal-block">
sudo apt-get install virtinst
</pre>
</li>
<li><p class="first">on CentOS:</p>
<pre class="literal-block">
sudo yum install libvirt python-virtinst qemu-kvm
sudo /etc/init.d/libvirtd start
</pre>
</li>
</ul>
</li>
<li><p class="first">Get a <a class="reference external" href="https://raw.github.com/dtroyer/image-recipes/master/centos-6-x86_64.ks">CentOS 6 kickstart</a> file with minimal stuff and the extras that we need.  Included in <tt class="docutils literal">%post</tt> is a bit to resize the root filesystem to the size of the actual device provided to the VM.</p>
</li>
</ul>
<ul>
<li><p class="first">Create base image with <tt class="docutils literal"><span class="pre">virt-install</span></tt>:</p>
<pre class="literal-block">
sudo virt-install \
    --name centos-6-x86_64 \
    --ram 1024 \
    --cpu host \
    --vcpus 1 \
    --nographics \
    --os-type=linux \
    --os-variant=rhel6 \
    --location=http://mirrors.kernel.org/centos/6/os/x86_64 \
    --initrd-inject=centos-6-x86_64.ks \
    --extra-args=&quot;ks=file:/centos-6-x86_64.ks text console=tty0 utf8 console=ttyS0,115200&quot; \
    --disk path=/var/lib/libvirt/images/centos-6-x86_64.img,size=2,bus=virtio \
    --force \
    --noreboot
</pre>
</li>
<li><p class="first">Point to the bridge with external connectivity if it is not <cite>eth0</cite>:</p>
<pre class="literal-block">
--network=bridge=br0
</pre>
</li>
<li><p class="first">If <tt class="docutils literal">libguestfs</tt> is functional on your build platform:</p>
<pre class="literal-block">
sudo yum install -y libguestfs-tools
sudo virt-sysprep --no-selinux-relabel -a /var/lib/libvirt/images/centos-6-x86_64.img
sudo virt-sparsify --convert qcow2 --compress /var/lib/libvirt/images/centos-6-x86_64.img centos-6-x86_64.qcow2
</pre>
</li>
<li><p class="first">Kick it into the cloud image repository:</p>
<pre class="literal-block">
glance image-create --name &quot;CentOS 6 x86_64&quot; \
    --disk-format qcow2 --container-format bare \
    --is-public false --file centos-6-x86_64.qcow2
</pre>
</li>
</ul>
<!-- save for selinux enforcing
# SELinux: relabelling all filesystem
echo "guestfis selinux relabel"
guestfish - -selinux -i $IMGNAME.$EXT <<EOF
sh load_policy
sh 'restorecon -Rv /'
EOF -->
</div>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2015/03/08/plug-in-to-openstackclient/">Plug In To OpenStackClient</a></li>
      <li><a href="/x/blog/2014/10/24/how-dost-thy-cloud-know-me-let-me-count-the-ways/">How Dost Thy Cloud Know Me, Let Me Count The Ways</a></li>
      <li><a href="/x/blog/2014/10/08/first-principles-glossary/">First Principles - Glossary</a></li>
      <li><a href="/x/blog/2014/10/03/a-funny-thing-happened-on-the-way-to-the-summit/">A Funny Thing Happened On The Way To The Summit</a></li>
      <li><a href="/x/blog/2014/09/15/openstack-low-level-api/">OpenStack Low Level API</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2015
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






