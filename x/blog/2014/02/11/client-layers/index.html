

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="client-layers"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2014/02/11/client-layers/" rel="bookmark" title="Permanent Link to Client Layers">Client Layers</a></h1>
      <p><small><span class="blog_post_date">February 11, 2014 at 02:11 AM</span> | categories: 
        <span class="blog_post_categories"><a href='/x/blog/category/openstackclient-sdk/'>openstackclient sdk</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p>[Work In Progress, you have been warned]</p>
<p>So clients are like pie.  Creamy, gooey, butterscotch cream pie with meringue.  Known at the in-laws house as Baby Bear Pie for reasons unknown-to-me.  Meringue is yummy but not much by itself.  Pie crust does its job most of the time without being noticed, unless it is sub-par.  It's the cream filling that gets all of the attention.  Butterscotch, lemon or chocolate, that's where the glory is.</p>
<p>REST clients are like pie, what with their multiple layers of communication handlers, data marshallers and output formatters and all.  So lets talk client crust.  It is the least sexy of the layers, going about its job, semi-appreciated when it is right, scorned when it is bad and otherwise taken for granted.  In OpenStack we have a large number of client projects that all talk to REST APIs.  Without going too far into the history, most of these are forks of forks and all have been independently enhanced and updated and none of them have more than a familial resemblance to each other.</p>
<p>Alessio Ababilov tried to fix this, actually making a working common REST layer for the (at the time) 5 or so client libraries.  This was proposed to oslo-incubator and has gained some traction of late.  Some things that did get merged early on were the change to use the Requests package to replace httplib2, but that did nothing to unify the low-level internal API.</p>
<p>Rather than try to fix the legacy clients the right solution here is to define some requirements and build a solid common foundation that API libraries can build on.  Rather than call it crust, let's use the even-less-sexy 'transport layer' name, totally mis-appropriated from the OSI stack.</p>
<p>Independent of the Oslo apiclient work, Jamie Lennox rebuilt the transport layer of keystoneclient as part of a refactor of the authentication bits into pluggable classes.  This happens to be excitingly close to what I had been prototyping in OpenStackClient and was possibly the biggest highlight of the week in Hong Kong.</p>
<p>So lets see if we can't turn that into a generic SDK-style transport layer for our clients.  On top of that we will layer the basic OpenStack API version discovery, authentication and service catalog.</p>
<div class="section" id="layer-1-transport-layer">
<h1>Layer 1: Transport Layer</h1>
<p>The Transport Layer includes the basic components that implement the REST API client and essentially is a wrapper around the Python Requests package with some additional header handling and logging built in.</p>
<div class="section" id="design-notes">
<h2>Design Notes</h2>
<p>The rationale for some of the differences from the 'traditional' client structure:</p>
<ul class="simple">
<li>There is only 1 client (HTTPClient) instance.  This takes the role similar to OpenStackClient's ClientManager class.  It handles the authentication for all APIs one time and contains the instances of the specific API client objects, which now are little more than containers for their Manager class instances.</li>
</ul>
</div>
<div class="section" id="namespace">
<h2>Namespace</h2>
<p>Everything lives under the top-level <tt class="docutils literal">openstack</tt> namespace</p>
<ul class="simple">
<li><tt class="docutils literal">openstack.restapi</tt> - The layer 1 transport and base classes (session, exceptions) and  base layer 2 classes (discovery, base clients, service catalog)</li>
<li><tt class="docutils literal">openstack.restapi.auth</tt> - The base authentication classes</li>
<li><tt class="docutils literal">openstack.restapi.identity</tt>  - API-specific classes required for layer 2 operation (identity client)</li>
<li><tt class="docutils literal">openstack.client.identity</tt> - The layer 2 classes for the Identity API (<tt class="docutils literal">.v2_0</tt>, <tt class="docutils literal">.v3</tt>)</li>
<li><tt class="docutils literal"><span class="pre">openstack.client.&lt;api&gt;</span></tt> - Other layer 2 API classes</li>
</ul>
</div>
<div class="section" id="openstack-restapi-session-session">
<h2>openstack.restapi.session.Session</h2>
<p>Session is the lowest layer, basically a wrapper that adds the following to requests.Session:</p>
<ul class="simple">
<li>create a new requests.Session instance if one is not supplied (using requests.Session implies the TLS control lies here and is one reason for passing in an existing Session)</li>
<li>populate the X-Auth-Token header from an auth object contained by the Session that implements a get_token() method</li>
<li>populate headers as required: User-Agent, Forwarded, Content-Type</li>
<li>change requests' redirect handling to be more appropriate for an API</li>
<li>include wrappers for the REST methods: head(), get(), post(), put(), delete(), patch()</li>
<li>debug logging of request/response data</li>
</ul>
</div>
<div class="section" id="openstack-restapi-baseclient-client">
<h2>openstack.restapi.baseclient.Client</h2>
<p>The base Client class defines the methods that reflect into the Session.</p>
<ul class="simple">
<li>create a new Session instance if one is not supplied</li>
<li>contains a ServiceCatalog instance (applications requiring multiple identity contexts at a time should use multiple Client instances)</li>
<li>performs the API version discovery (see ApiVersion class below)</li>
<li>define the cache interface for client-side caching of API data</li>
<li>include wrappers for the REST methods: head(), get(), post(), put(), delete(), patch()</li>
</ul>
</div>
<div class="section" id="openstack-restapi-base-baseauthplugin">
<h2>openstack.restapi.base.BaseAuthPlugin</h2>
<p>The abstract auth plugin class</p>
<blockquote>
<ul class="simple">
<li>handles the specifics of authenticating a user and providing a token to Session when requested via get_token()</li>
</ul>
</blockquote>
</div>
<div class="section" id="openstack-restapi-httpclient-httpclient-baseclient-client-base-baseauthplugin">
<h2>openstack.restapi.httpclient.HTTPClient(baseclient.Client, base.BaseAuthPlugin)</h2>
<p>HTTPClient is the primary interface used by the project API layers (gooey-creamy!).</p>
<ul class="simple">
<li>creates a ServiceCatalog from the token received from Identity</li>
<li>uses <tt class="docutils literal">keyring</tt> to cache tokens</li>
<li>authenticate() calls get_raw_token_from_identity_service()</li>
</ul>
</div>
<div class="section" id="openstack-restapi-access-accessinfo">
<h2>openstack.restapi.access.AccessInfo</h2>
<p>Base class for auth plugins</p>
<ul class="simple">
<li>defines the basic auth interface</li>
<li>AccessInfoV2</li>
<li>AccessInfoV3</li>
</ul>
</div>
</div>
<div class="section" id="layer-2-discovery">
<h1>Layer 2: Discovery</h1>
<p>Discovery rides just above the transport layer and is the logic used to determine the best API version available between those support by the server and the client.</p>
<div class="section" id="openstack-restapi-api-discovery-apiversion">
<h2>openstack.restapi.api_discovery.ApiVersion</h2>
<p>A resource class for API versions used by BaseVersion</p>
<ul class="simple">
<li>normalizes version information</li>
</ul>
</div>
<div class="section" id="openstack-restapi-api-discovery-baseversion">
<h2>openstack.restapi.api_discovery.BaseVersion</h2>
<p>The root class for API version discovery.</p>
<ul class="simple">
<li>queries API server for supported version information</li>
<li>normalizes both server and client versions</li>
<li>select the appropriate version from those availalble (if possible)</li>
</ul>
</div>
<div class="section" id="openstack-restapi-identity-client-identityversion-api-discovery-baseversion">
<h2>openstack.restapi.identity.client.IdentityVersion(api_discovery.BaseVersion)</h2>
<p>A Version discovery class that handles the peculiarities of Keystone</p>
<ul class="simple">
<li>optionally removes 'v2.0' from the auth_url to do proper discovery on old-style deployment configurations</li>
<li>normalizes the returned dict to remove the <tt class="docutils literal">values</tt> key</li>
</ul>
</div>
</div>
<div class="section" id="layer-2-authentication">
<h1>Layer 2: Authentication</h1>
</div>
<div class="section" id="layer-2-service-catalog">
<h1>Layer 2: Service Catalog</h1>
</div>
<div class="section" id="examples">
<h1>Examples</h1>
<div class="section" id="create-a-session-with-private-ca-certificates">
<h2>Create A Session With Private CA Certificates</h2>
<pre class="literal-block">
session = api_session.Session(
    verify=ca_certificate_file,
    user_agent=USER_AGENT,
)
</pre>
</div>
<div class="section" id="add-a-base-client">
<h2>Add A Base Client</h2>
<pre class="literal-block">
client = httpclient.HTTPClient(
    session=session,
    auth_url=&quot;https://localhost:5000&quot;,
    project_name=&quot;sez-me-street&quot;,
    username=&quot;bert&quot;,
    password=&quot;pidgeon&quot;,
)
</pre>
</div>
<div class="section" id="identity-version-discovery">
<h2>Identity Version Discovery</h2>
<pre class="literal-block">
# Supported Identity client classes
API_VERSIONS = {
    '2.0': 'keystoneclient.v2_0.client.Client',
    '3': 'keystoneclient.v3.client.Client',
}

ver = identity.client.IdentityVersion(
    clients=API_VERSIONS.keys(),
    auth_url=&quot;https://localhost:5000&quot;,
)
print &quot;client class: %s=%s&quot; % (ver.client_version.id, API_VERSIONS[ver.server_version.id])
</pre>
</div>
</div>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2015/03/30/qa-code-sprint/">QA Code Sprint</a></li>
      <li><a href="/x/blog/2015/03/08/plug-in-to-openstackclient/">Plug In To OpenStackClient</a></li>
      <li><a href="/x/blog/2015/02/11/real-world-devstack-configuration/">Real World DevStack Configuration</a></li>
      <li><a href="/x/blog/2014/10/24/how-dost-thy-cloud-know-me-let-me-count-the-ways/">How Dost Thy Cloud Know Me, Let Me Count The Ways</a></li>
      <li><a href="/x/blog/2014/10/08/first-principles-glossary/">First Principles - Glossary</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2015
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






