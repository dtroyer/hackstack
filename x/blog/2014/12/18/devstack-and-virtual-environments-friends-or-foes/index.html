

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackStack Posts</title>
  <meta name="description" content="OpenStack and other hackish things">
  <meta name="author" content="dtroyer">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0"
        href="/x/blog/feed/">
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0"
        href="/x/blog/feed/atom/">

  <link rel="shortcut icon" href="/x/favicon.ico">
  <link rel="apple-touch-icon"
        href="/x/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/x/css/base.css?v=1">
  <link rel="stylesheet" href="/x/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld"
        href="/x/css/handheld.css?v=1">
  <link rel="stylesheet"
        href="/x/css/pygments_murphy.css">

  <script
    src="/x/js/libs/modernizr-1.7.min.js">
  </script>

  <link rel="stylesheet" href="/x/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quantico' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1>
      <a href="/x/">
        HackStack Posts
      </a>
    </h1>
    <h2>OpenStack and other hackish things</h2>
  </div>
  <div id="navigation" class="grid_12">
    
    
    <ul class="theme_font">
      <li>
        
        <a href="/x/" class="">Home</a>
      </li>
      <li>
        
        <a href="/x/blog" class="selected">Blog</a>
      </li>
      <li>
        
        <a href="/x/blog/archive/" class="">Archives</a>
      </li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_11">
            




<article>
  <div class="blog_post">
    <header>
      <div id="devstack-and-virtual-environments-friends-or-foes"></div>
      <h1 class="blog_post_title"><a href="/x/blog/2014/12/18/devstack-and-virtual-environments-friends-or-foes/" rel="bookmark" title="Permanent Link to DevStack and Virtual Environments - Friends or Foes?">DevStack and Virtual Environments - Friends or Foes?</a></h1>
      <p><small><span class="blog_post_date">December 18, 2014 at 12:18 PM</span> | categories: 
        <span class="blog_post_categories">devstack</span>
      </small></p>
    </header>
    <div class="post_prose">
      
<div class="document">
<p>DevStack has always utilized a mix of distro-provided and PyPI-installed
packages in creating the Python operating environment for OpenStack services.
The actual mix has varied over time, but as the complexity of the
environment continues to increase that mix swings toward more of the
packages coming from PyPI.</p>
<p>The extreme position of the swing toward PyPI packages is to build a virtual
environment that does not utilize system Python packages and run all of OpenStack
there.  DevStack has actively avoided using virtual environments, until now.</p>
<p>This is the story of shoving the venv rug <em>under</em> DevStack...</p>
<p>I've created <tt class="docutils literal">tools/build_venv.sh</tt> to encapsulate all of the build logic
so it can stand alone or be called from <tt class="docutils literal">stack.sh</tt>,
similar to how <tt class="docutils literal">tools/install_prereqs.sh</tt> is used.  Some
Python packages require distro packages to be installed to properly build
(pyOpenSSL, etc) so we need to install the distro packages and build and
install the PyPI packages
in the venv.</p>
<p>There is no mapping between PyPI packages and their distro-specific
package dependencies; DevStack has a set of files listing the package
requirements per-project for Debian/Ubuntu, Fedora/RHEL/CentOS and openSUSE,
but that is a little too broad for our base use.  A new file <tt class="docutils literal"><span class="pre">files/*/venv</span></tt>
lists the dependencies, with comments linking back to the PyPI package
that requires it.  <tt class="docutils literal">tools/build_venv.sh</tt> installs the distro packages
before doing the pip installs.</p>
<p>The list of Python packages to be installed by default is kept in
<tt class="docutils literal"><span class="pre">files/venv-requirements.txt</span></tt> in the usual requirements file format.
<tt class="docutils literal">tools/build_venv.sh</tt> uses that as the source for additional packages
to install in the new venv, essentially feeding it directly to pip.
It also accepts package names on the command line.</p>
<p>Once <tt class="docutils literal">tools/build_venv.sh</tt> successfully builds and installs all of the
requested packages, it is time to teach <tt class="docutils literal">stack.sh</tt> to build the venv.
It turns out there are a handfull of places in DevStack that made some
assumptions or need to know when a venv is active:</p>
<ul class="simple">
<li><tt class="docutils literal">get_python_exec_prefix()</tt> needs to return the venv <tt class="docutils literal">bin</tt> dir rather than
the distro-supplied installation directory.</li>
<li><tt class="docutils literal">pip_install()</tt> should not be root to install into a venv.</li>
<li>Keystone running under <tt class="docutils literal">mod_wsgi</tt> needs to know to activate the venv.
This means modifying the <tt class="docutils literal">.wsgi</tt> files in <tt class="docutils literal">/var/www/keystone</tt>, which as
you might have noticed, have no <tt class="docutils literal">.wsgi</tt> extension.</li>
<li>Nova rootwrap is configured globally and is not required...move it into
<tt class="docutils literal">configure_nova_rootwrap()</tt> function.  But that's just cosmetic.  The real
rootwrap problem is that sudo is resetting the PATH and the <tt class="docutils literal"><span class="pre">nova-rootwrap</span></tt>
binary can not be found, so set the default sudo path to $PATH.  In a more
secure world we would append <tt class="docutils literal">$VIRTUAL_ENV/bin</tt> to the default sudo path.</li>
</ul>
<p>Setting <tt class="docutils literal">USE_VENV=True</tt> in <tt class="docutils literal">local.conf</tt> causes <tt class="docutils literal">stack.sh</tt> to build a
virtual environment in <tt class="docutils literal"><span class="pre">/opt/stack/global-venv</span></tt> (by default, set
<tt class="docutils literal">VENV_PATH</tt> to change) and activate it so everything else uses it during that run.</p>
<p>The major problem now is anything that wants to run Python code in that
namespace must also activate the venv.  Saving off the venv environment
variables in <tt class="docutils literal">.stackenv</tt> at the end of <tt class="docutils literal">stack.sh</tt> simplifies the
activation in other scripts.  Adding the activation to <tt class="docutils literal">openrc</tt> is
really the right solution as all DevStack exercises and other stuff
uses <tt class="docutils literal">openrc</tt> to set up the operating environment.</p>
<p>As of post time this work is being done in <a class="reference external" href="https://review.openstack.org/#/c/142822/">this review</a> in Gerrit.
Stay tuned to see how it all works out...</p>
</div>


    </div>
  </div>
</article>




          </div>
          <div id="sidebar" class="grid_1">
            <aside>
  <section>
<!--
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/x/blog/2017/04/14/who-are-we-really-really/">Who Are We?  Really?  Really!</a></li>
      <li><a href="/x/blog/2015/04/30/client-cloud-configuration/">Client Cloud Configuration</a></li>
      <li><a href="/x/blog/2015/04/18/openstackclient-is-three-and-official/">OpenStackClient Is Three and Official</a></li>
      <li><a href="/x/blog/2015/03/30/qa-code-sprint/">QA Code Sprint</a></li>
      <li><a href="/x/blog/2015/03/08/plug-in-to-openstackclient/">Plug In To OpenStackClient</a></li>
    </ul>
-->
  </section>
<!--
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
-->
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/x/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2017
        dtroyer
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/x/js/plugins.js"></script>
  <script src="/x/js/script.js"></script>
  <script src="/x/js/jquery.tweet.js"></script>  
  <script src="/x/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






